function memoize(b){var c={};return function(d){return void 0===c[d]?(c[d]=b(d),c[d]):c[d]}}function zip(c,a){return c.map(function(b,c){return[b,a[c]]})}function cons(b,a){return function(c){return 0==c?b:a(c-1)}}function skip(a,b){return function(c){return b(c+a)}}function map(a){return function(b){return function(c){return a(b(c))}}}function bboxesIntersect(a,b){return!(a.x+a.width<b.x||a.y+a.height<b.y||b.x+b.width<a.x||b.y+b.height<a.y)}function bboxEq(a,b){var c=.001;return a.x>=b.x-c&&a.x<=b.x+c&&a.y>=b.y-c&&a.y<=b.y+c&&a.width>=b.width-c&&a.width<=b.width+c&&a.height>=b.height-c&&a.height<=b.height+c}function mergeBBoxes(a,b){var c=Math.max,d=Math.min,e=d(a.x,b.x),f=d(a.y,b.y),g=c(a.x+a.width,b.x+b.width),h=c(a.y+a.height,b.y+b.height);return{x:e,y:f,width:g-e,height:h-f}}function bboxForPoints(a){for(var b=Number.MAX_VALUE,c=Number.MIN_VALUE,d=Math.max,e=Math.min,f,g=c,h=c,i=b,j=b,k=0,l=a;k<l.length;k++)f=l[k],g=d(g,f.x),i=e(i,f.x),h=d(h,f.y),j=e(j,f.y);return{x:i,y:i,width:g-i,height:h-j}}var linebreak=require("./linebreak").linebreak();function justify(a,b,c,d){var e=[];return c.forEach(function(c,f,g){var h=c.text.split(/\s/),i=a(c.fontFamily,c.fontSize," "),j={space:{width:d&&d.space.width||3,stretch:d&&d.space.stretch||6,shrink:d&&d.space.shrink||9}},k=a(c.fontFamily,c.fontSize,"-"),l=i*j.space.width/j.space.stretch,m=i*j.space.width/j.space.shrink;h.forEach(function(d,h,j){var n=c.hyphenate?b.hyphenate(d):[d];1<n.length&&4<d.length?n.forEach(function(b,d,f){e.push({style:c,value:linebreak.box(a(c.fontFamily,c.fontSize,b),b)}),d!==f.length-1&&e.push({style:c,value:linebreak.penalty(k,100,1)})}):e.push({style:c,value:linebreak.box(a(c.fontFamily,c.fontSize,d),d)}),f===g.length-1&&h===j.length-1?(e.push({style:c,value:linebreak.glue(0,linebreak.infinity,0)}),e.push({style:c,value:linebreak.penalty(0,-linebreak.infinity,1)})):h!=j.length-1&&e.push({style:c,value:linebreak.glue(i,l,m)})})}),e}function left(a,b,c,d){var e=[];return c.forEach(function(c,f,g){var h=c.text.split(/\s/),i=a(c.fontFamily,c.fontSize," "),j={space:{width:d&&d.space.width||3,stretch:d&&d.space.stretch||6,shrink:d&&d.space.shrink||9}},k=a(c.fontFamily,c.fontSize,"-");h.forEach(function(d,h,j){var l=c.hyphenate?b.hyphenate(d):[d];1<l.length&&4<d.length?l.forEach(function(b,d,f){e.push({style:c,value:linebreak.box(a(c.fontFamily,c.fontSize,b),b)}),d!==f.length-1&&e.push({style:c,value:linebreak.penalty(k,100,1)})}):e.push({style:c,value:linebreak.box(a(c.fontFamily,c.fontSize,d),d)}),f===g.length-1&&h===j.length-1?(e.push({style:c,value:linebreak.glue(0,linebreak.infinity,0)}),e.push({style:c,value:linebreak.penalty(0,-linebreak.infinity,1)})):h!=j.length-1&&(e.push({style:c,value:linebreak.glue(0,12,0)}),e.push({style:c,value:linebreak.penalty(0,0,0)}),e.push({style:c,value:linebreak.glue(i,-12,0)}))})}),e}function center(a,b,c,d){var e=[];return 0<c.length&&(e.push({style:c[0],value:linebreak.box(0,"")}),e.push({style:c[0],value:linebreak.glue(0,12,0)})),c.forEach(function(c,f,g){var h=c.text.split(/\s/),i=a(c.fontFamily,c.fontSize," "),j={space:{width:d&&d.space.width||3,stretch:d&&d.space.stretch||6,shrink:d&&d.space.shrink||9}},k=a(c.fontFamily,c.fontSize,"-");h.forEach(function(d,h,j){var l=b.hyphenate(d);1<l.length&&4<d.length?l.forEach(function(b,d,f){e.push({style:c,value:linebreak.box(a(c.fontFamily,c.fontSize,b),b)}),d!==f.length-1&&e.push({style:c,value:linebreak.penalty(k,100,1)})}):e.push({style:c,value:linebreak.box(a(c.fontFamily,c.fontSize,d),d)}),f===g.length-1&&h===j.length-1?(e.push({style:c,value:linebreak.glue(0,12,0)}),e.push({style:c,value:linebreak.penalty(0,-linebreak.infinity,0)})):h!=j.length-1&&(e.push({style:c,value:linebreak.glue(0,12,0)}),e.push({style:c,value:linebreak.penalty(0,0,0)}),e.push({style:c,value:linebreak.glue(i,-24,0)}),e.push({style:c,value:linebreak.box(0,"")}),e.push({style:c,value:linebreak.penalty(0,linebreak.infinity,0)}),e.push({style:c,value:linebreak.glue(0,12,0)}))})}),e}var idRenderer=function(){return[[],[]]};function landscape(a){return{width:a.height,height:a.width}}var formats={"4A0":{width:4767.87,height:6740.79},"2A0":{width:3370.39,height:4767.87},A0:{width:2383.94,height:3370.39},A1:{width:1683.78,height:2383.94},A2:{width:1190.55,height:1683.78},A3:{width:841.89,height:1190.55},A4:{width:595.28,height:841.89},A5:{width:419.53,height:595.28},A6:{width:297.64,height:419.53},A7:{width:209.76,height:297.64},A8:{width:147.4,height:209.76},A9:{width:104.88,height:147.4},A10:{width:73.7,height:104.88},B0:{width:2834.65,height:4008.19},B1:{width:2004.09,height:2834.65},B2:{width:1417.32,height:2004.09},B3:{width:1000.63,height:1417.32},B4:{width:708.66,height:1000.63},B5:{width:498.9,height:708.66},B6:{width:354.33,height:498.9},B7:{width:249.45,height:354.33},B8:{width:175.75,height:249.45},B9:{width:124.72,height:175.75},B10:{width:87.87,height:124.72},C0:{width:2599.37,height:3676.54},C1:{width:1836.85,height:2599.37},C2:{width:1298.27,height:1836.85},C3:{width:918.43,height:1298.27},C4:{width:649.13,height:918.43},C5:{width:459.21,height:649.13},C6:{width:323.15,height:459.21},C7:{width:229.61,height:323.15},C8:{width:161.57,height:229.61},C9:{width:113.39,height:161.57},C10:{width:79.37,height:113.39},RA0:{width:2437.8,height:3458.27},RA1:{width:1729.13,height:2437.8},RA2:{width:1218.9,height:1729.13},RA3:{width:864.57,height:1218.9},RA4:{width:609.45,height:864.57},SRA0:{width:2551.18,height:3628.35},SRA1:{width:1814.17,height:2551.18},SRA2:{width:1275.59,height:1814.17},SRA3:{width:907.09,height:1275.59},SRA4:{width:637.8,height:907.09},EXECUTIVE:{width:521.86,height:756},FOLIO:{width:612,height:936},LEGAL:{width:612,height:1008},LETTER:{width:612,height:792},TABLOID:{width:792,height:1224}},linebreak$1=require("./typeset/linebreak").linebreak();function combine(a){return function(b,c){for(var d=[],e=[],f=[],g=0,h=a;g<h.length;g++){var i=h[g],j=i[0],k=i[1],l=k(b,map(j)(c)),m=l[0],n=l[1];e=e.concat(m),f=f.concat(n)}for(var o={},p=0,q=e;p<q.length;p++)for(var r=q[p],s=0,t=void 0,u=!1;t=c(s);){if(bboxesIntersect(r,t))void 0===o[s]&&(o[s]=[]),o[s].push(r),u=!0;else if(u)break;s++}for(var v=Object.keys(o).sort(),w=0,x=v;w<x.length;w++){for(var y=x[w],z=o[y],A=z[0],s=1;s<z.length;s++)A=mergeBBoxes(A,z[s]);d.push(A)}return[d,f]}}function vertically(a){return function(b,c){for(var d=[],e=c,f=[],g=0,h=a;g<h.length;g++){var i=h[g],j=i(b,e),k=j[0],l=j[1];if(0<k.length){for(var m=null,n=k[k.length-1],o=0;null!==(m=e(o))&&!bboxesIntersect(m,n);)o++;if(null!=m){var p={x:m.x,y:n.y+n.height,width:m.width,height:m.y+m.height-(n.y+n.height)};e=0<p.height?cons(p,skip(o+1,e)):skip(o+1,e)}}f=f.concat(k),d=d.concat(l)}return[f,d]}}function renderParagraph(a){var b=Math.floor,c=Math.min;return function(d,e){var f,g,h,k,l=[],m=0,n=null,o=[],p=function(a,c){for(var d=0,f=0,g=null;null!==(g=e(f));){if(c-d<g.height)return[g,f];d+=b(g.height/a)*a,f++}return[null,f]},q=function(b){var c=p(a.leading,m+(b+1)*a.leading),d=c[0],e=c[1],f=(a.leftIndentation?a.leftIndentation(b):0)+(a.rightIndentation?a.rightIndentation(b):0);return null===d?null:d.width-f};switch(a.align){case"left":default:k=left;break;case"center":k=center;break;case"justify":k=justify;}for(var s=k(d.measure,a.hypher,a.spans,null),t=linebreak$1(s.map(function(a){return a.value}),memoize(q),{tolerance:a.tolerance||10}),u=[],v=0,w=1;w<t.length;w+=1){for(var x=t[w].position,z=t[w].ratio,r=v;r<s.length;r+=1)if("box"===s[r].value.type||"penalty"===s[r].value.type&&s[r].value.penalty===-linebreak$1.infinity){v=r;break}u.push({ratio:z,nodes:s.slice(v,x+1),position:x}),v=x}f=0,u.forEach(function(b,c){var e,i=0,j=0,k=a.leftIndentation?a.leftIndentation(c):0;f+=a.leading,m+=a.leading,e=p(a.leading,m),g=e[0],h=e[1],null===n||bboxEq(g,n)||(f=a.leading),n=g,b.nodes.forEach(function(a,c,e){var h=d.fontMetrics(a.style.fontFamily).ascender,m=-h/1e3*a.style.fontSize,n=g.x+i,o=g.y+f;if("box"===a.value.type){if(0===i){var p=a.value.value[0]?d.glyphMetrics(a.style.fontFamily,a.value.value[0]).leftBearing:0;j=-p/1e3*a.style.fontSize}l.push({type:"text",x:n+j+k,y:o+m,span:a.style,text:a.value.value}),i+=a.value.width}else"glue"===a.value.type?i+=a.value.width+b.ratio*(0>b.ratio?a.value.shrink:a.value.stretch):"penalty"===a.value.type&&100===a.value.penalty&&c===e.length-1&&l.push({type:"text",x:n+j+k,y:o+m,span:a.style,text:"-"})})});for(var A=0;A<h;A++)o.push(e(A));return null!==g&&void 0!==g&&o.push({x:g.x,y:g.y,width:g.width,height:c(g.height,f+(a.paragraphLeading||0))}),[o,l]}}function renderText(a){return vertically(a.map(function(a){return renderParagraph(a)}))}function renderColumns(a,b){for(var c=[],d=0,e=0,f=b;e<f.length;e++){var g=f[e],h=g[0],i=g[1];c.push([[d,h],i]),d+=h+a}var j=function(a){var b=a[0],c=a[1];return function(a){return{x:a.x+b,y:a.y,width:c,height:a.height}}};return combine(c.map(function(a){var b=a[0],c=a[1];return[j(b),c]}))}function renderTable(a,b,c){return vertically(c.map(function(c){return renderColumns(a,zip(b,c))}))}function renderPolygon(a,b){return function(c,d){var e=d(0),f=bboxForPoints(a);return[[{x:e.x+f.x,y:e.y+f.x,width:f.width,height:f.height}],[{type:"polygon",x:e.x,y:e.y,points:a.map(function(a){return{x:a.x+e.x,y:a.y+e.y}}),style:b}]]}}function pdfKitDocMeasures(a){return{measure:function(b,c,d){return a.font(b)._font.widthOfString(d,c)},fontMetrics:function(b){return{ascender:a.font(b)._font.ascender}},glyphMetrics:function(b,c){return{leftBearing:a.font(b)._font.font.layout(c).glyphs[0]._metrics.leftBearing}}}}function jsPdfDocMeasures(a){return{measure:function(b,c,d){var e=(b+"").split("\t");return a.setFont(e[0],e[1]).getStringUnitWidth(d)*c},fontMetrics:function(){return{ascender:0}},glyphMetrics:function(){return{leftBearing:0}}}}function setStyle(a,b){b.lineWidth!==void 0&&a.lineWidth(b.lineWidth),b.strokeColor!==void 0&&a.strokeColor(b.strokeColor),b.fillColor!==void 0&&a.fillColor(b.fillColor),b.strokeOpacity!==void 0&&a.strokeOpacity(b.fillColor),b.fillOpacity!==void 0&&a.fillOpacity(b.fillColor),b.lineJoin!==void 0&&a.lineJoin(b.lineJoin),b.lineCap!==void 0&&a.lineCap(b.lineCap)}function renderToPages(a,b,c,d){for(var e=Math.floor,f,g=0,h=0,i=c;h<i.length;h++){f=i[h];for(var j=0,k=f;j<k.length;j++){var l=k[j],m=e(l.y/b.height);g=Math.max(g,m)}}var n=Array(g+1).fill([]);if(d)for(var m=0;m<=g;m++)for(var f,o=0,p=d(m);o<p.length;o++){f=p[o];for(var l,q=0,r=f;q<r.length;q++)l=r[q],n[m].push(l)}for(var f,s=0,t=c;s<t.length;s++){f=t[s];for(var u=0,v=f;u<v.length;u++){var l=v[u],m=e(l.y/b.height);n[m].push(l)}}for(var m=0;m<=g;m++){0!=m&&a.addPage();for(var l,w=0,x=n[m];w<x.length;w++)switch(l=x[w],a.save(),l.type){case"text":a.save(),setStyle(a,l.span.style||{}),a.font(l.span.fontFamily).fontSize(l.span.fontSize)._fragment(l.text,l.x,l.y-m*b.height,l.span.options||{}),a.restore();break;case"polygon":a.save(),setStyle(a,l.style||{}),l.style.fillColor&&l.style.strokeColor?(a.polygon.apply(a,l.points.map(function(a){var b=a.x,c=a.y;return[b,c]})),a.fillAndStroke()):l.style.fillColor?(a.polygon.apply(a,l.points.map(function(a){var b=a.x,c=a.y;return[b,c]})),a.fill()):l.style.strokeColor&&(a.polygon.apply(a,l.points.map(function(a){var b=a.x,c=a.y;return[b,c]})),a.stroke()),a.restore();}}}function renderToPDF(a,b,c,d,e,f){var g=new e({layout:"portrait",size:[b.width,b.height]}),h=pdfKitDocMeasures(g),i=f.createWriteStream(a);g.pipe(i);var j;return d&&(j=function(a){return d(a).map(function(a){return a.renderer(h,a.bboxes)[1]})}),renderToPages(g,b,c.map(function(a){return a.renderer(h,a.bboxes)[1]}),j),g.end(),i}function withMargins(a,b,c,d,e){return function(f){return{tag:"new_page",x:e,y:f*a.height+b,width:a.width-(e+c),height:a.height-(b+d)}}}function columnsWithMargins(a,b,c,d,e,f){var g=Math.floor;return function(h){return 0==h%2?{tag:"new_page",x:f,y:g(h/2)*a.height+c,width:a.width/2-b/2-f,height:a.height-(c+e)}:{x:b/2+a.width/2,y:g(h/2)*a.height+c,width:a.width/2-b/2-d,height:a.height-(c+e)}}}var pageBreak=function(a,b){for(var c=0,d=[];"new_page"!==b(c).tag;)d.push(b(c)),c++;return[d,[]]};export{columnsWithMargins,combine,formats,idRenderer,jsPdfDocMeasures,landscape,pageBreak,pdfKitDocMeasures,renderColumns,renderParagraph,renderPolygon,renderTable,renderText,renderToPDF,renderToPages,vertically,withMargins};
