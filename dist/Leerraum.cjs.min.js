"use strict";function memoize(t){var n={};return function(e){return void 0!==n[e]||(n[e]=t(e)),n[e]}}function zip(e,n){return e.map(function(e,t){return[e,n[t]]})}function cons(t,n){return function(e){return 0==e?t:n(e-1)}}function skip(t,n){return function(e){return n(e+t)}}function map(n){return function(t){return function(e){return n(t(e))}}}function bboxesIntersect(e,t){return!(e.x+e.width<t.x||e.y+e.height<t.y||t.x+t.width<e.x||t.y+t.height<e.y)}function bboxEq(e,t){var n=.001;return e.x>=t.x-n&&e.x<=t.x+n&&e.y>=t.y-n&&e.y<=t.y+n&&e.width>=t.width-n&&e.width<=t.width+n&&e.height>=t.height-n&&e.height<=t.height+n}function mergeBBoxes(e,t){var n=Math.min(e.x,t.x),i=Math.min(e.y,t.y);return{x:n,y:i,width:Math.max(e.x+e.width,t.x+t.width)-n,height:Math.max(e.y+e.height,t.y+t.height)-i}}function bboxForPoints(e){for(var t=Number.MIN_VALUE,n=Number.MIN_VALUE,i=Number.MAX_VALUE,r=Number.MAX_VALUE,h=0,a=e;h<a.length;h++){var l=a[h];t=Math.max(t,l.x),i=Math.min(i,l.x),n=Math.max(n,l.y),r=Math.min(r,l.y)}return{x:i,y:i,width:t-i,height:n-r}}Object.defineProperty(exports,"__esModule",{value:!0});var linebreak=require("./linebreak").linebreak();function justify(f,g,e,n){var p=[];return e.forEach(function(r,h,a){var e=r.text.split(/\s/),l=f(r.fontFamily,r.fontSize," "),t={width:n&&n.space.width||3,stretch:n&&n.space.stretch||6,shrink:n&&n.space.shrink||9},o=f(r.fontFamily,r.fontSize,"-"),u=l*t.width/t.stretch,s=l*t.width/t.shrink;e.forEach(function(e,t,n){var i=r.hyphenate?g.hyphenate(e):[e];1<i.length&&4<e.length?i.forEach(function(e,t,n){p.push({style:r,value:linebreak.box(f(r.fontFamily,r.fontSize,e),e)}),t!==n.length-1&&p.push({style:r,value:linebreak.penalty(o,100,1)})}):p.push({style:r,value:linebreak.box(f(r.fontFamily,r.fontSize,e),e)}),h===a.length-1&&t===n.length-1?(p.push({style:r,value:linebreak.glue(0,linebreak.infinity,0)}),p.push({style:r,value:linebreak.penalty(0,-linebreak.infinity,1)})):t!==n.length-1&&p.push({style:r,value:linebreak.glue(l,u,s)})})}),p}function left(u,s,e,t){var f=[];return e.forEach(function(r,h,a){var e=r.text.split(/\s/),l=u(r.fontFamily,r.fontSize," "),o=(t&&t.space.width,t&&t.space.stretch,t&&t.space.shrink,u(r.fontFamily,r.fontSize,"-"));e.forEach(function(e,t,n){var i=r.hyphenate?s.hyphenate(e):[e];1<i.length&&4<e.length?i.forEach(function(e,t,n){f.push({style:r,value:linebreak.box(u(r.fontFamily,r.fontSize,e),e)}),t!==n.length-1&&f.push({style:r,value:linebreak.penalty(o,100,1)})}):f.push({style:r,value:linebreak.box(u(r.fontFamily,r.fontSize,e),e)}),h===a.length-1&&t===n.length-1?(f.push({style:r,value:linebreak.glue(0,linebreak.infinity,0)}),f.push({style:r,value:linebreak.penalty(0,-linebreak.infinity,1)})):t!==n.length-1&&(f.push({style:r,value:linebreak.glue(0,12,0)}),f.push({style:r,value:linebreak.penalty(0,0,0)}),f.push({style:r,value:linebreak.glue(l,-12,0)}))})}),f}function center(u,s,e,t){var f=[];return 0<e.length&&(f.push({style:e[0],value:linebreak.box(0,"")}),f.push({style:e[0],value:linebreak.glue(0,12,0)})),e.forEach(function(r,h,a){var e=r.text.split(/\s/),l=u(r.fontFamily,r.fontSize," "),o=(t&&t.space.width,t&&t.space.stretch,t&&t.space.shrink,u(r.fontFamily,r.fontSize,"-"));e.forEach(function(e,t,n){var i=s.hyphenate(e);1<i.length&&4<e.length?i.forEach(function(e,t,n){f.push({style:r,value:linebreak.box(u(r.fontFamily,r.fontSize,e),e)}),t!==n.length-1&&f.push({style:r,value:linebreak.penalty(o,100,1)})}):f.push({style:r,value:linebreak.box(u(r.fontFamily,r.fontSize,e),e)}),h===a.length-1&&t===n.length-1?(f.push({style:r,value:linebreak.glue(0,12,0)}),f.push({style:r,value:linebreak.penalty(0,-linebreak.infinity,0)})):t!==n.length-1&&(f.push({style:r,value:linebreak.glue(0,12,0)}),f.push({style:r,value:linebreak.penalty(0,0,0)}),f.push({style:r,value:linebreak.glue(l,-24,0)}),f.push({style:r,value:linebreak.box(0,"")}),f.push({style:r,value:linebreak.penalty(0,linebreak.infinity,0)}),f.push({style:r,value:linebreak.glue(0,12,0)}))})}),f}var idRenderer=function(e,t){return[[],[]]};function landscape(e){return{width:e.height,height:e.width}}var formats={"4A0":{width:4767.87,height:6740.79},"2A0":{width:3370.39,height:4767.87},A0:{width:2383.94,height:3370.39},A1:{width:1683.78,height:2383.94},A2:{width:1190.55,height:1683.78},A3:{width:841.89,height:1190.55},A4:{width:595.28,height:841.89},A5:{width:419.53,height:595.28},A6:{width:297.64,height:419.53},A7:{width:209.76,height:297.64},A8:{width:147.4,height:209.76},A9:{width:104.88,height:147.4},A10:{width:73.7,height:104.88},B0:{width:2834.65,height:4008.19},B1:{width:2004.09,height:2834.65},B2:{width:1417.32,height:2004.09},B3:{width:1000.63,height:1417.32},B4:{width:708.66,height:1000.63},B5:{width:498.9,height:708.66},B6:{width:354.33,height:498.9},B7:{width:249.45,height:354.33},B8:{width:175.75,height:249.45},B9:{width:124.72,height:175.75},B10:{width:87.87,height:124.72},C0:{width:2599.37,height:3676.54},C1:{width:1836.85,height:2599.37},C2:{width:1298.27,height:1836.85},C3:{width:918.43,height:1298.27},C4:{width:649.13,height:918.43},C5:{width:459.21,height:649.13},C6:{width:323.15,height:459.21},C7:{width:229.61,height:323.15},C8:{width:161.57,height:229.61},C9:{width:113.39,height:161.57},C10:{width:79.37,height:113.39},RA0:{width:2437.8,height:3458.27},RA1:{width:1729.13,height:2437.8},RA2:{width:1218.9,height:1729.13},RA3:{width:864.57,height:1218.9},RA4:{width:609.45,height:864.57},SRA0:{width:2551.18,height:3628.35},SRA1:{width:1814.17,height:2551.18},SRA2:{width:1275.59,height:1814.17},SRA3:{width:907.09,height:1275.59},SRA4:{width:637.8,height:907.09},EXECUTIVE:{width:521.86,height:756},FOLIO:{width:612,height:936},LEGAL:{width:612,height:1008},LETTER:{width:612,height:792},TABLOID:{width:792,height:1224}},linebreak$1=require("./typeset/linebreak").linebreak();function combine(M){return function(e,t){for(var n=[],i=[],r=[],h=0,a=M;h<a.length;h++){var l=a[h],o=l[0],u=(0,l[1])(e,map(o)(t)),s=u[0],f=u[1];i=i.concat(s),r=r.concat(f)}for(var g={},p=0,d=i;p<d.length;p++)for(var y=d[p],c=0,v=void 0,x=!1;v=t(c);){if(bboxesIntersect(y,v))void 0===g[c]&&(g[c]=[]),g[c].push(y),x=!0;else if(x)break;c++}for(var w=0,b=Object.keys(g).sort();w<b.length;w++){var k=g[b[w]],m=k[0];for(c=1;c<k.length;c++)m=mergeBBoxes(m,k[c]);n.push(m)}return[n,r]}}function vertically(d){return function(e,t){for(var n=[],i=t,r=[],h=0,a=d;h<a.length;h++){var l=(0,a[h])(e,i),o=l[0],u=l[1];if(0<o.length){for(var s=null,f=o[o.length-1],g=0;null!==(s=i(g))&&!bboxesIntersect(s,f);)g++;if(null!=s){var p={x:s.x,y:f.y+f.height,width:s.width,height:s.y+s.height-(f.y+f.height)};i=0<p.height?cons(p,skip(g+1,i)):skip(g+1,i)}}r=r.concat(o),n=n.concat(u)}return[r,n]}}function renderParagraph(b){return function(f,h){function r(e,t){for(var n=0,i=0,r=null;null!==(r=h(i));){if(t-n<r.height)return[r,i];n+=Math.floor(r.height/e)*e,i++}return[null,i]}var g,p,n,e,d=[],a=0,i=null,t=[];switch(b.align){case"left":default:e=left;break;case"center":e=center;break;case"justify":e=justify}for(var l=e(f.measure,b.hypher,b.spans,null),o=linebreak$1(l.map(function(e){return e.value}),memoize(function(e){var t=r(b.leading,a+(e+1)*b.leading),n=t[0],i=(t[1],(b.leftIndentation?b.leftIndentation(e):0)+(b.rightIndentation?b.rightIndentation(e):0));return null!==n?n.width-i:null}),{tolerance:b.tolerance||10}),u=[],s=0,y=1;y<o.length;y+=1){for(var c=o[y].position,v=o[y].ratio,x=s;x<l.length;x+=1)if("box"===l[x].value.type||"penalty"===l[x].value.type&&l[x].value.penalty===-linebreak$1.infinity){s=x;break}u.push({ratio:v,nodes:l.slice(s,c+1),position:c}),s=c}g=0,u.forEach(function(l,e){var t,o=0,u=0,s=b.leftIndentation?b.leftIndentation(e):0;g+=b.leading,a+=b.leading,t=r(b.leading,a),p=t[0],n=t[1],null===i||bboxEq(p,i)||(g=b.leading),i=p,l.nodes.forEach(function(e,t,n){var i=-f.fontMetrics(e.style.fontFamily).ascender/1e3*e.style.fontSize,r=p.x+o,h=p.y+g;if("box"===e.value.type){if(0===o){var a=e.value.value[0]?f.glyphMetrics(e.style.fontFamily,e.value.value[0]).leftBearing:0;u=-a/1e3*e.style.fontSize}d.push({type:"text",x:r+u+s,y:h+i,span:e.style,text:e.value.value}),o+=e.value.width}else"glue"===e.value.type?o+=e.value.width+l.ratio*(l.ratio<0?e.value.shrink:e.value.stretch):"penalty"===e.value.type&&100===e.value.penalty&&t===n.length-1&&d.push({type:"text",x:r+u+s,y:h+i,span:e.style,text:"-"})})});for(var w=0;w<n;w++)t.push(h(w));return null!=p&&t.push({x:p.x,y:p.y,width:p.width,height:Math.min(p.height,g+(b.paragraphLeading||0))}),[t,d]}}function renderText(e){return vertically(e.map(function(e){return renderParagraph(e)}))}function renderColumns(e,t){for(var n=[],i=0,r=0,h=t;r<h.length;r++){var a=h[r],l=a[0],o=a[1];n.push([[i,l],o]),i+=l+e}return combine(n.map(function(e){var t,n,i,r=e[0],h=e[1];return[(t=r,n=t[0],i=t[1],function(e){return{x:e.x+n,y:e.y,width:i,height:e.height}}),h]}))}function renderTable(t,n,e){return vertically(e.map(function(e){return renderColumns(t,zip(n,e))}))}function renderPolygon(r,h){return function(e,t){var n=t(0),i=bboxForPoints(r);return[[{x:n.x+i.x,y:n.y+i.x,width:i.width,height:i.height}],[{type:"polygon",x:n.x,y:n.y,points:r.map(function(e){return{x:e.x+n.x,y:e.y+n.y}}),style:h}]]}}function pdfKitDocMeasures(i){return{measure:function(e,t,n){return i.font(e)._font.widthOfString(n,t)},fontMetrics:function(e){return{ascender:i.font(e)._font.ascender}},glyphMetrics:function(e,t){return{leftBearing:i.font(e)._font.font.layout(t).glyphs[0]._metrics.leftBearing}}}}function jsPdfDocMeasures(r){return{measure:function(e,t,n){var i=String(e).split("\t");return r.setFont(i[0],i[1]).getStringUnitWidth(n)*t},fontMetrics:function(e){return{ascender:0}},glyphMetrics:function(e,t){return{leftBearing:0}}}}function setStyle(e,t){void 0!==t.lineWidth&&e.lineWidth(t.lineWidth),void 0!==t.strokeColor&&e.strokeColor(t.strokeColor),void 0!==t.fillColor&&e.fillColor(t.fillColor),void 0!==t.strokeOpacity&&e.strokeOpacity(t.fillColor),void 0!==t.fillOpacity&&e.fillOpacity(t.fillColor),void 0!==t.lineJoin&&e.lineJoin(t.lineJoin),void 0!==t.lineCap&&e.lineCap(t.lineCap)}function renderToPages(e,t,n,i){for(var r=0,h=0,a=n;h<a.length;h++)for(var l=0,o=a[h];l<o.length;l++){var u=o[l],s=Math.floor(u.y/t.height);r=Math.max(r,s)}var f=Array(r+1).fill([]);if(i)for(s=0;s<=r;s++)for(var g=0,p=i(s);g<p.length;g++)for(var d=0,y=p[g];d<y.length;d++){u=y[d];f[s].push(u)}for(var c=0,v=n;c<v.length;c++)for(var x=0,w=v[c];x<w.length;x++){u=w[x];f[s=Math.floor(u.y/t.height)].push(u)}for(s=0;s<=r;s++){0!=s&&e.addPage();for(var b=0,k=f[s];b<k.length;b++){u=k[b];switch(e.save(),u.type){case"text":e.save(),setStyle(e,u.span.style||{}),e.font(u.span.fontFamily).fontSize(u.span.fontSize)._fragment(u.text,u.x,u.y-s*t.height,u.span.options||{}),e.restore();break;case"polygon":e.save(),setStyle(e,u.style||{}),u.style.fillColor&&u.style.strokeColor?(e.polygon.apply(e,u.points.map(function(e){return[e.x,e.y]})),e.fillAndStroke()):u.style.fillColor?(e.polygon.apply(e,u.points.map(function(e){return[e.x,e.y]})),e.fill()):u.style.strokeColor&&(e.polygon.apply(e,u.points.map(function(e){return[e.x,e.y]})),e.stroke()),e.restore()}}}}function renderToPDF(e,t,n,i,r,h){var a=new r({layout:"portrait",size:[t.width,t.height]}),l=pdfKitDocMeasures(a),o=h.createWriteStream(e);a.pipe(o);var u=void 0;return i&&(u=function(e){return i(e).map(function(e){return e.renderer(l,e.bboxes)[1]})}),renderToPages(a,t,n.map(function(e){return e.renderer(l,e.bboxes)[1]}),u),a.end(),o}function withMargins(t,n,i,r,h){return function(e){return{tag:"new_page",x:h,y:e*t.height+n,width:t.width-(h+i),height:t.height-(n+r)}}}function columnsWithMargins(t,n,i,r,h,a){return function(e){return e%2==0?{tag:"new_page",x:a,y:Math.floor(e/2)*t.height+i,width:t.width/2-n/2-a,height:t.height-(i+h)}:{x:n/2+t.width/2,y:Math.floor(e/2)*t.height+i,width:t.width/2-n/2-r,height:t.height-(i+h)}}}var pageBreak=function(e,t){for(var n=0,i=[];"new_page"!==t(n).tag;)i.push(t(n)),n++;return[i,[]]};exports.columnsWithMargins=columnsWithMargins,exports.combine=combine,exports.formats=formats,exports.idRenderer=idRenderer,exports.jsPdfDocMeasures=jsPdfDocMeasures,exports.landscape=landscape,exports.pageBreak=pageBreak,exports.pdfKitDocMeasures=pdfKitDocMeasures,exports.renderColumns=renderColumns,exports.renderParagraph=renderParagraph,exports.renderPolygon=renderPolygon,exports.renderTable=renderTable,exports.renderText=renderText,exports.renderToPDF=renderToPDF,exports.renderToPages=renderToPages,exports.vertically=vertically,exports.withMargins=withMargins;
